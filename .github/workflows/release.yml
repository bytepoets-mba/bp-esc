name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache: 'npm' # Removed temporarily as it causes issues if lockfile isn't synced correctly

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin, aarch64-apple-darwin

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          # Use the same cache for all release tags to maximize hits
          shared-key: "release-build"
          workspaces: ". -> target"
          # Disable job-id key to allow cache persistence across different workflow runs
          add-job-id-key: false

      - name: Install dependencies
        run: npm ci

      - name: Download Sparkle Framework
        run: |
          cd src-tauri
          curl -L -o /tmp/sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz"
          tar -xf /tmp/sparkle.tar.xz -C /tmp
          cp -R /tmp/Sparkle.framework .
          mkdir -p sparkle-bin
          cp -R /tmp/bin/* sparkle-bin/
          chmod +x sparkle-bin/*
          echo "Sparkle framework and tools installed"

      - name: Import Apple Certificate
        if: env.APPLE_CERTIFICATE != ''
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Build Tauri app
        run: |
          npm run build:frontend
          npx tauri build --bundles app --target universal-apple-darwin
        env:
          CI: true
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: "Developer ID Application: BYTEPOETS GmbH"
          # This is critical for Notarization
          ENABLE_HARDENED_RUNTIME: true

      - name: Notarize App Bundle
        if: env.APPLE_ID != ''
        run: |
          PRODUCT_NAME=$(node -e "console.log(require('./src-tauri/tauri.conf.json').productName)")
          APP_PATH="target/universal-apple-darwin/release/bundle/macos/$PRODUCT_NAME.app"
          ZIP_PATH="target/universal-apple-darwin/release/bundle/macos/$PRODUCT_NAME.zip"
          
          echo "üì¶ Zipping for notarization..."
          ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"
          
          echo "üöÄ Submitting to Apple Notary Service..."
          xcrun notarytool submit "$ZIP_PATH" \
            --apple-id "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APPLE_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --wait
          
          echo "üé´ Stapling notarization ticket..."
          # Try to staple, but don't fail if it doesn't work (can still distribute)
          xcrun stapler staple "$APP_PATH" || echo "‚ö†Ô∏è Stapling failed, but app is notarized and can be distributed"
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}

      - name: Build DMG via node-appdmg
        run: node scripts/build-dmg.js

      - name: Zip App for Sparkle
        run: |
          PRODUCT_NAME=$(node -e "console.log(require('./src-tauri/tauri.conf.json').productName)")
          APP_PATH="target/universal-apple-darwin/release/bundle/macos/$PRODUCT_NAME.app"
          ZIP_PATH="target/universal-apple-darwin/release/bundle/macos/$PRODUCT_NAME.zip"
          
          echo "üì¶ Creating Sparkle update zip..."
          ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"

      - name: Generate Appcast
        run: |
          # Create output directory
          mkdir -p appcast-output
          
          # Copy .zip to output directory for appcast generation
          PRODUCT_NAME=$(node -e "console.log(require('./src-tauri/tauri.conf.json').productName)")
          cp "target/universal-apple-darwin/release/bundle/macos/$PRODUCT_NAME.zip" appcast-output/
          
          # Generate appcast.xml with EdDSA signature using the tool we downloaded earlier
          ./src-tauri/sparkle-bin/generate_appcast \
            --ed-key-file <(echo "${{ secrets.SPARKLE_PRIVATE_KEY }}") \
            --download-url-prefix "https://github.com/bytepoets-mba/bp-esc/releases/download/${{ github.ref_name }}/" \
            --link "https://github.com/bytepoets-mba/bp-esc" \
            --full-release-notes-url "https://github.com/bytepoets-mba/bp-esc/releases/tag/${{ github.ref_name }}" \
            appcast-output/
          
          # Move appcast.xml to root for release attachment
          mv appcast-output/appcast.xml .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/universal-apple-darwin/release/bundle/dmg/*.dmg
            target/universal-apple-darwin/release/bundle/macos/*.zip
            appcast.xml
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
