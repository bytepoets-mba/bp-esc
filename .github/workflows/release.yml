name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache: 'npm' # Removed temporarily as it causes issues if lockfile isn't synced correctly

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin, aarch64-apple-darwin

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          # Use the same cache for all release tags to maximize hits
          shared-key: "release-build"
          workspaces: "src-tauri -> target"

      - name: Install dependencies
        run: npm ci

      - name: Import Apple Certificate
        if: env.APPLE_CERTIFICATE != ''
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Build Tauri app
        run: |
          npm run build:frontend
          npx tauri build --bundles app --target universal-apple-darwin
        env:
          CI: true
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: "Developer ID Application: BYTEPOETS GmbH"
          # This is critical for Notarization
          ENABLE_HARDENED_RUNTIME: true

      - name: Notarize App Bundle
        if: env.APPLE_ID != ''
        run: |
          PRODUCT_NAME=$(node -e "console.log(require('./src-tauri/tauri.conf.json').productName)")
          APP_PATH="target/universal-apple-darwin/release/bundle/macos/$PRODUCT_NAME.app"
          ZIP_PATH="target/universal-apple-darwin/release/bundle/macos/$PRODUCT_NAME.zip"
          
          echo "ðŸ“¦ Zipping for notarization..."
          ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"
          
          echo "ðŸš€ Submitting to Apple Notary Service..."
          # Capture submission ID and wait for result
          SUBMISSION_ID=$(xcrun notarytool submit "$ZIP_PATH" \
            --apple-id "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APPLE_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --wait | grep "id:" | head -1 | awk '{print $2}')
          
          echo "ðŸŽ« Stapling notarization ticket..."
          xcrun stapler staple "$APP_PATH"
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}

      - name: Build DMG via node-appdmg
        run: node scripts/build-dmg.js

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: target/universal-apple-darwin/release/bundle/dmg/*.dmg
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
