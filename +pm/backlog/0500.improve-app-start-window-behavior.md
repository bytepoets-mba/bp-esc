# Improve App Start Window Behavior

## Problem Analysis

### Current Behavior
1. **Rust side (main.rs lines 848-853)**: The app checks `settings.show_window_on_start` and shows/hides the window accordingly
2. **JavaScript side (app.js lines 547-550)**: The app loads settings and:
   - If `api_key` exists → calls `loadBalance()`
   - If no `api_key` → shows settings screen
   - No coordination between window visibility and API key validation

### Issues Identified
1. **Window shows regardless of API key validity**: The Rust code shows the window based only on `show_window_on_start` setting, without checking if the API key is valid
2. **No validation of API key before showing window**: Even if the API key is malformed or invalid, the window will still show
3. **Settings screen logic is separate**: The JavaScript only shows settings if there's no API key at all, not if the key is invalid
4. **Race condition possible**: Window might show briefly before realizing the API key doesn't work

## Required Behavior

### Desired Flow
1. **App starts** → Read settings
2. **Check `show_window_on_start`** → If false, keep window hidden
3. **If `show_window_on_start` is true**:
   - Validate API key format (starts with "sk-", proper length)
   - Attempt to fetch balance with the API key
   - **If API key is valid and works** → Show main window with balance
   - **If API key is invalid/empty/doesn't work** → Show settings screen instead

### Edge Cases to Handle
- Empty API key → Show settings
- Malformed API key (wrong format) → Show settings  
- Valid format but invalid/expired key → Show settings
- Network errors during validation → Show settings with error
- First-time users (no settings file) → Show settings

## Implementation Strategy

### Frontend Changes (app.js)
1. Modify `init()` function to:
   - First validate API key format before attempting balance load
   - Handle balance loading failures by showing settings
   - Return success/failure status to Rust

### Backend Changes (main.rs)
1. Modify window startup logic to:
   - Wait for frontend validation result
   - Only show window if validation succeeds AND `show_window_on_start` is true
   - Handle communication between frontend validation and window visibility

### Communication Approach
- Use Tauri event system to communicate validation result from JS to Rust
- Frontend emits `api-key-validation-result` event with success/failure
- Backend listens for this event before deciding window visibility

## Priority
**High** - This affects user experience on every app launch and can cause confusion when windows appear with invalid API keys.