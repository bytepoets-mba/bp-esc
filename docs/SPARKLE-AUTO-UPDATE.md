# Sparkle Auto-Update Setup

BP-ESC uses [Sparkle](https://sparkle-project.org/) for native macOS auto-updates.

## Overview

- **Framework**: Sparkle 2.8.1 (EdDSA signing)
- **Plugin**: `tauri-plugin-sparkle-updater` v0.2
- **Feed URL**: https://github.com/bytepoets-mba/bp-esc/releases/latest/download/appcast.xml
- **Hosting**: GitHub Releases (works with private repos)
- **Check Interval**: Every 24 hours (configurable)

## Architecture

1. **App checks** `appcast.xml` hosted in GitHub Releases (latest release)
2. **Sparkle compares** versions, shows native macOS dialog if update available
3. **User clicks** "Install", Sparkle downloads `.zip` from GitHub Releases
4. **EdDSA signature** verified before installation
5. **App relaunches** automatically after update

**Why GitHub Releases?**
- Works with private repos (GitHub Pages requires paid plan for private repos)
- Keeps everything in one place (binaries + appcast)
- No additional hosting setup needed

## Files

- `src-tauri/Info.plist` - Sparkle configuration (feed URL, public key, check interval)
- `src-tauri/Sparkle.framework` - Native macOS framework (bundled with app)
- `src-tauri/sparkle-bin/` - CLI tools for key generation and signing
- `appcast.xml` - Update feed (auto-generated by CI, attached to GitHub Releases)

## One-Time Setup (Already Done)

### 1. EdDSA Keys

Generated with:
```bash
cd src-tauri
./sparkle-bin/generate_keys
```

- **Private key**: Stored in macOS Keychain + GitHub Secret `SPARKLE_PRIVATE_KEY`
- **Public key**: `l6lDxyzIiSEDuBCJXnPEutvm5JJwbkM2t8+NyD8B2NM=` (in `Info.plist`)

### 2. GitHub Releases (No Setup Needed)

The CI workflow automatically attaches `appcast.xml` to each GitHub Release.

Sparkle fetches from: `https://github.com/bytepoets-mba/bp-esc/releases/latest/download/appcast.xml`

This works with private repos (no paid GitHub plan required).

### 3. GitHub Secret

Export private key and add to GitHub:
```bash
cd src-tauri
./sparkle-bin/generate_keys -x /tmp/private-key.txt
# Copy content of /tmp/private-key.txt
# Add to: Settings → Secrets → Actions → New repository secret
# Name: SPARKLE_PRIVATE_KEY
```

⚠️ **Security**: Keep private key secure. Never commit to git.

## How It Works

### Release Process

When you push a tag (e.g., `v0.4.0`), CI:

1. Builds universal binary `.app`
2. Code signs and notarizes
3. Creates `.dmg` for distribution
4. **Creates `.zip` for Sparkle updates**
5. **Generates `appcast.xml` with EdDSA signature**
6. **Creates GitHub Release with `.dmg`, `.zip`, and `appcast.xml`**

### Update Check Flow

1. App checks `appcast.xml` every 24h (background)
2. If new version found, native dialog appears:
   - Release notes (from GitHub Release body)
   - "Install" and "Later" buttons
   - Download progress bar
3. User clicks "Install":
   - Downloads `.zip` from GitHub Releases
   - Verifies EdDSA signature
   - Replaces app bundle
   - Relaunches app

### Manual Check

Users can check manually via Settings → "Check for Updates" button.

## Configuration

Edit `src-tauri/Info.plist`:

```xml
<!-- Check for updates every 24 hours (86400 seconds) -->
<key>SUScheduledCheckInterval</key>
<integer>86400</integer>

<!-- Enable automatic checks -->
<key>SUEnableAutomaticChecks</key>
<true/>

<!-- Download and install without user confirmation (default: false) -->
<key>SUAutomaticallyUpdate</key>
<false/>
```

## Testing Updates

1. **Build current version:**
   ```bash
   npm run build
   # Install the .app on your system
   ```

2. **Bump version** in `tauri.conf.json`, `Cargo.toml`, `package.json`

3. **Create release:**
   ```bash
   ./scripts/release.sh
   ```

4. **Wait for CI** to complete and deploy `appcast.xml`

5. **Open installed app**, click "Check for Updates"

6. **Update dialog** should appear with new version

## Troubleshooting

### "No updates available" when testing

- Verify `appcast.xml` exists in latest release:
  - Go to: https://github.com/bytepoets-mba/bp-esc/releases/latest
  - Check if `appcast.xml` is listed as an asset
  - Or check directly: https://github.com/bytepoets-mba/bp-esc/releases/latest/download/appcast.xml
- Check version in app matches older version (not the new one)
- Look at appcast - is new version listed?
- Check console logs in app for Sparkle errors

### Signature verification failed

- Private key in GitHub Secrets matches public key in Info.plist?
- CI used correct private key when generating appcast?
- Re-export private key:
  ```bash
  cd src-tauri
  ./sparkle-bin/generate_keys -x /tmp/private-key.txt
  # Update GitHub Secret
  ```

### App crashes after update

- Check code signing: `codesign -vv /Applications/BP-ESC.app`
- Check entitlements match release.entitlements
- Verify hardened runtime enabled

### Update check doesn't run

- Check Info.plist has correct `SUFeedURL`
- Verify app was built in release mode (dev mode disables Sparkle)
- Check 24h interval hasn't elapsed yet (or click "Check for Updates" manually)

## Development Notes

- **Sparkle only works in release builds** (not `tauri dev`)
- Plugin returns `None` in dev mode - normal behavior
- Test with production `.app` builds only
- Use `--debug` builds for faster iteration (still needs `.app` bundle)

## Security

- **EdDSA signatures** prevent malicious updates
- **HTTPS-only** feed URL (GitHub Pages)
- **Code signing** + **notarization** required for macOS
- Private key stored in Keychain (local) and GitHub Secrets (CI)

## Cost

- **GitHub Releases**: Free storage (works with private repos)
- **Sparkle Framework**: MIT licensed, free
- **No paid GitHub plan required**: Unlike GitHub Pages, Releases work with private repos on free plan

No third-party services or accounts required.

## References

- [Sparkle Documentation](https://sparkle-project.org/documentation/)
- [tauri-plugin-sparkle-updater](https://github.com/ahonn/tauri-plugin-sparkle-updater)
- [Sparkle EdDSA Signing](https://sparkle-project.org/documentation/publishing/#eddsa-ed25519-signatures)
- [GitHub Pages](https://docs.github.com/en/pages)
